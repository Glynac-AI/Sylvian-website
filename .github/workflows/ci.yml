name: Docker Image CI

on:
  push:
    branches: ["main"]
    paths:
      - "**/**"

env:
  PRODUCT_VERSION: "latest"
  VERSION: "1.2.0"
  ENVIRONMENT: "s9p"
  DOCKER_IMAGE: image-reg.ops.glynac.ai/glynac-fe/sylvian-web

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      IMAGE_TAG: ${{ steps.export_tag.outputs.IMAGE_TAG }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Generate IMAGE_TAG
        id: export_tag
        run: |
          IMAGE_TAG="${ENVIRONMENT}-v${VERSION}-${GITHUB_SHA}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: image-reg.ops.glynac.ai
          username: admin
          password: ${{ secrets.HARBOR_TOKEN }}

      - name: Build & Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          #   build-args: |
          #     NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
          #     RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          #     RESEND_FROM_EMAIL=${{ secrets.RESEND_FROM_EMAIL }}
          #     RESEND_TO_EMAIL=${{ secrets.RESEND_TO_EMAIL }}
          #     NEXT_PUBLIC_USE_STRAPI=${{ secrets.NEXT_PUBLIC_USE_STRAPI }}
          #     NEXT_PUBLIC_STRAPI_URL=${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
          #     STRAPI_API_TOKEN=${{ secrets.STRAPI_API_TOKEN }}
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: build

    env:
      IMAGE_TAG: ${{ needs.build.outputs.IMAGE_TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nomad
        uses: hashicorp/setup-nomad@main
        with:
          version: ${{ env.PRODUCT_VERSION }}

      - name: Update Nomad job image tag
        run: |
          sed -i "s|IMAGE_TAG_PLACEHOLDER|${IMAGE_TAG}|g" nomad/sylvian.hcl

      - name: Deploy to Nomad
        env:
          NOMAD_ADDR: ${{ vars.NOMAD_ADDR }}
          NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}
        run: |
          nomad job run nomad/sylvian.hcl

  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          IMAGE_TAG: ${{ needs.build.outputs.IMAGE_TAG }}
          JOB_STATUS: ${{ needs.deploy.result }}
        run: |
          PIPELINE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"

          if [ "$JOB_STATUS" = "success" ]; then
            STATUS="SUCCESS"
            EMOJI="‚úÖ"
          elif [ "$JOB_STATUS" = "cancelled" ]; then
            STATUS="CANCELLED"
            EMOJI="‚ö†Ô∏è"
          else
            STATUS="FAILED"
            EMOJI="‚ùå"
          fi

          MESSAGE=$(printf "üöÄ Sylvian Web Service Deployment\n\nüì¶ Image: %s\nüåø Branch: %s\nüë§ Triggered by: %s\nüìä Status: %s %s\n\nüîó %s" \
            "$IMAGE_TAG" \
            "$BRANCH" \
            "$ACTOR" \
            "$EMOJI" \
            "$STATUS" \
            "$PIPELINE_URL")

          if [ -z "$TELEGRAM_THREAD_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "message_thread_id=${TELEGRAM_THREAD_ID}" \
              --data-urlencode "text=${MESSAGE}"
          fi
